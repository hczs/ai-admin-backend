import os

from loguru import logger
from shapely import wkt
import pandas as pd
from django.conf import settings
import geojson
import folium
from common.utils import return_location, get_background_url, random_style


def dataframe_to_geojson(df):
    """
    解析dataframe对象（dataframe必须得有 wkt字段），转换为geojson数据
    """
    features = []
    for idx, row in df.iterrows():
        p = wkt.loads(row['wkt'])
        properties = row.to_dict()
        del properties['wkt']
        feature_json = geojson.Feature(geometry=p, properties=properties)
        features.append(feature_json)
    return geojson.FeatureCollection(features)


def learning_result_map(dataset_file, task_id, background_id):
    """
    路网表征学习 生成结果地图文件，文件名：数据集名称_task_id_result.html
    """
    # 准备csv文件路径
    csv_path = None
    result_dir = settings.EVALUATE_PATH_PREFIX + str(task_id) + settings.EVALUATE_PATH_SUFFIX
    file_list = os.listdir(result_dir)
    for file in file_list:
        if file.endswith(".csv"):
            csv_path = result_dir + file
    if not csv_path:
        logger.error('The task result csv file not found')
        return
    logger.info('learning_result_map: result file path is ' + csv_path)
    # 根据class分组
    df = pd.read_csv(csv_path)
    grouped = df.groupby('class')
    map = None
    for name, group in grouped:
        map = folium.Map(
            location=return_location(dataframe_to_geojson(group)),
            zoom_start=12,
            tiles=get_background_url(background_id),
            attr='default'
        )
        break
    if not map:
        logger.error('csv file format error')
    # 把每组的数据单独渲染一份geojson
    for name, group in grouped:
        folium.GeoJson(dataframe_to_geojson(group),
                       name=name,
                       tooltip=name,
                       style_function=random_style).add_to(map)
    # 所有geojson加完，生成html
    folium.LayerControl().add_to(map)
    map_save_path = settings.ADMIN_FRONT_HTML_PATH + dataset_file.file_name + "_" + str(task_id) + "_result.html"
    map.save(map_save_path)
    logger.info('learning_result_map: the html file path is ' + map_save_path)
